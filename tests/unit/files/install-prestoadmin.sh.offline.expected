#!/bin/bash
set -e

if [ -d "third-party"]; then
    tar xvzf third-party/virtualenv-12.0.7.tar.gz -C third-party || true
    python third-party/virtualenv-12.0.7/virtualenv.py presto-admin-install
else
    wget https://pypi.python.org/packages/source/v/virtualenv/virtualenv-12.0.7.tar.gz
    tar xvzf virtualenv-12.0.7.tar.gz || true
    python virtualenv-12.0.7/virtualenv.py presto-admin-install
fi

source presto-admin-install/bin/activate
cert_file=$1
# trust pypi.python.org by default, otherwise use cert_file provided
cert_options='--trusted-host pypi.python.org'
if [ -n "$1" ]; then
    if [ ! -f  $cert_file ]; then
        echo "Adding pypi.python.org as trusted-host. Cannot find certificate file: "$cert_file
    else
        cert_options='--cert '$cert_file
    fi
fi

pip install $cert_options wheel_name.whl --no-index --find-links third-party
deactivate

cat > `pwd`/presto-admin << EOT
#!/bin/bash
export VIRTUAL_ENV="`pwd`/presto-admin-install"
export PATH="\$VIRTUAL_ENV/bin:\$PATH"
unset PYTHON_HOME

exec presto-admin \$@
EOT
chmod 755 `pwd`/presto-admin

LOG_DIR=/var/log/prestoadmin
mkdir -p $LOG_DIR

CONF_DIR=/etc/opt/prestoadmin
mkdir -p $CONF_DIR
